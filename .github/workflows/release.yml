name: Release

on:
  push:
    tags:
      - 'v*-tested'

env:
  TESTED_TAG: ${{ github.ref_name }}

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build binaries
    defaults:
      run:
        shell: bash
    runs-on: ${{ matrix.os }}
    outputs:
      final_tag: ${{ steps.metadata.outputs.tag }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x86_64
          - os: windows-latest
            target: windows-x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine final version
        id: metadata
        run: |
          tested_tag="${TESTED_TAG}"
          if [[ "${tested_tag}" != *-tested ]]; then
            echo "Tag ${tested_tag} does not assert test completion." >&2
            exit 1
          fi
          final_tag="${tested_tag%-tested}"
          echo "tag=${final_tag}" >> "$GITHUB_OUTPUT"

      - name: Set up uv
        uses: astral-sh/setup-uv@v1
        with:
          version: latest

      - name: Install Python
        run: uv python install 3.13

      - name: Install dependencies
        run: uv sync --group build

      - name: Note tested provenance
        run: echo "Tests already validated by PR Quality Gate workflow."

      - name: Build binary
        run: uv run pyinstaller --onefile --name ephetzner main.py

      - name: Prepare artifacts
        env:
          TARGET: ${{ matrix.target }}
          VERSION: ${{ steps.metadata.outputs.tag }}
        shell: bash
        run: |
          uv run python - <<'PY'
          import hashlib
          import os
          import pathlib
          import shutil

          version = os.environ['VERSION']
          target = os.environ['TARGET']
          dist = pathlib.Path('dist')
          out = pathlib.Path('build-artifacts')
          out.mkdir(exist_ok=True)

          binaries = [f for f in dist.iterdir() if f.is_file()]
          if not binaries:
              raise SystemExit('No binaries produced by PyInstaller')
          binary = binaries[0]
          suffix = binary.suffix
          dest_name = f"ephetzner-{version}-{target}{suffix}"
          dest = out / dest_name
          shutil.copy2(binary, dest)

          digest = hashlib.sha256(dest.read_bytes()).hexdigest()
          with (out / 'SHA256SUMS').open('w', encoding='utf-8') as handle:
              handle.write(f"{digest}  {dest.name}\n")
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ephetzner-${{ matrix.target }}
          path: build-artifacts

  release:
    name: Publish release
    needs: build
    runs-on: ubuntu-latest
    env:
      TESTED_TAG: ${{ github.ref_name }}
      BUILD_FINAL_TAG: ${{ needs.build.outputs.final_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Determine final version
        id: metadata
        run: |
          tested_tag="${TESTED_TAG}"
          if [[ "${tested_tag}" != *-tested ]]; then
            echo "Tag ${tested_tag} does not assert test completion." >&2
            exit 1
          fi
          final_tag="${tested_tag%-tested}"
          commit_ref=$(git rev-list -n 1 "$GITHUB_REF")
          echo "FINAL_TAG=${final_tag}" >> "$GITHUB_ENV"
          echo "COMMIT_REF=${commit_ref}" >> "$GITHUB_ENV"

      - name: Cross-check build metadata
        if: ${{ needs.build.outputs.final_tag != '' }}
        run: |
          if [ "${BUILD_FINAL_TAG}" != "${FINAL_TAG}" ]; then
            echo "Mismatch between build output ${BUILD_FINAL_TAG} and release computation ${FINAL_TAG}." >&2
            exit 1
          fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Generate source archive
        run: |
          mkdir -p release-assets/source
          git archive --format=zip --output release-assets/source/ephetzner-${FINAL_TAG}-src.zip "${COMMIT_REF}"

      - name: Combine checksums
        run: |
          set -e
          cd release-assets
          python - <<'PY'
          import pathlib

          root = pathlib.Path('.')
          combined = root / 'SHA256SUMS'
          sources = sorted(p for p in root.rglob('SHA256SUMS') if p.is_file())

          with combined.open('w', encoding='utf-8') as handle:
            for path in sources:
              if path == combined:
                continue
              handle.write(path.read_text(encoding='utf-8'))
          PY

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          set -e
          commit_ref="${COMMIT_REF}"
          PREV_TAG=$(git tag --sort=-creatordate | grep -E '^v[0-9]+(\.[0-9]+)*$' | grep -Fv "${FINAL_TAG}" | head -n 1)
          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:'- %s' "$commit_ref" > release-assets/CHANGELOG.md
          else
            git log --pretty=format:'- %s' "${PREV_TAG}..${commit_ref}" > release-assets/CHANGELOG.md
          fi
          python - <<'PY'
          import os
          from pathlib import Path

          notes_path = Path('release-assets/CHANGELOG.md')
          notes = notes_path.read_text(encoding='utf-8')
          output_path = Path(os.environ['GITHUB_OUTPUT'])

          with output_path.open('a', encoding='utf-8') as handle:
              handle.write('notes<<EOF\n')
              handle.write(notes)
              if not notes.endswith('\n'):
                  handle.write('\n')
              handle.write('EOF\n')
          PY

      - name: Create canonical release tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git ls-remote --tags origin "${FINAL_TAG}" | grep -q "${FINAL_TAG}$"; then
            echo "Canonical tag ${FINAL_TAG} already exists on origin."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "${FINAL_TAG}" "${COMMIT_REF}" -m "Release ${FINAL_TAG}"
            git push origin "${FINAL_TAG}"
          fi

      - name: Remove existing release (if any)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ env.FINAL_TAG }}
        run: |
          if gh release view "$VERSION" >/dev/null 2>&1; then
            gh release delete "$VERSION" -y
          fi

      - name: Publish GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ env.FINAL_TAG }}
        run: |
          set -e
          gh release create "$VERSION" \
            --repo "$GITHUB_REPOSITORY" \
            --title "$VERSION" \
            --notes-file release-assets/CHANGELOG.md

          mapfile -t assets < <(find release-assets -type f -print | sort)
          sleep 3
          for asset in "${assets[@]}"; do
            gh release upload "$VERSION" "$asset" \
              --repo "$GITHUB_REPOSITORY" \
              --clobber
          done

      - name: Delete tested tag
        env:
          TESTED_TAG: ${{ env.TESTED_TAG }}
        run: |
          git push origin ":${TESTED_TAG}" || true
          git tag -d "${TESTED_TAG}" || true
